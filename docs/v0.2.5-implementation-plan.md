# Overture v0.2.5 Implementation Plan: Binary Detection

**Version:** 0.2.5
**Status:** Planning
**Estimated Time:** 15-18 hours
**Target Coverage:** 85%+

---

## Overview

Add intelligent binary detection to determine which AI development clients are actually installed on the system. Generate MCP configs only for confirmed installations while warning about missing binaries.

---

## Task Breakdown by Phase

### Phase 1: Core Infrastructure (2-3 hours)

#### Task 1.1: Create Binary Detection Types
**File:** `apps/cli/src/domain/config.types.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7` (TypeScript type patterns)
**Parallelizable:** ✅ Yes (independent task)
**Dependencies:** None

**Description:**
- Add `BinaryDetectionStatus` type: `'found' | 'not-found' | 'skipped'`
- Add `BinaryDetectionResult` interface with status, binaryPath, version, appBundlePath, warnings
- Add `clients.skipBinaryDetection` option to `OvertureConfig` interface

**Deliverable:**
```typescript
export type BinaryDetectionStatus = 'found' | 'not-found' | 'skipped';

export interface BinaryDetectionResult {
  status: BinaryDetectionStatus;
  binaryPath?: string;
  version?: string;
  appBundlePath?: string;
  warnings: string[];
}
```

---

#### Task 1.2: Create BinaryDetector Service
**File:** `apps/cli/src/core/binary-detector.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7` (Node.js process patterns), `sequentialthinking`
**Parallelizable:** ⚠️ Partial (can start interface, implementation depends on 1.3)
**Dependencies:** Task 1.1 (types), Task 1.3 (adapter interface)

**Description:**
- Implement `detectClient(client: ClientAdapter, platform: Platform): Promise<BinaryDetectionResult>`
- Implement `detectBinary(binaryName: string): Promise<{found: boolean, path?: string, version?: string}>`
  - Use `ProcessExecutor.commandExists()` for binary detection
  - Use `ProcessExecutor.exec(binary, ['--version'])` for version detection
  - Parse version from stdout (handle multiple formats)
  - Add 5s timeout per check
- Implement `detectAppBundle(paths: string[]): Promise<{found: boolean, path?: string}>`
  - Check filesystem for app bundle existence
  - Verify directory/executable permissions
- Implement `validateConfigFile(path: string): boolean`
  - Read file and ensure valid JSON
  - Return false if file doesn't exist or invalid JSON

**Deliverable:** Complete `BinaryDetector` service with all methods

---

#### Task 1.3: Extend ClientAdapter Interface
**File:** `apps/cli/src/adapters/client-adapter.interface.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7` (TypeScript interface patterns)
**Parallelizable:** ✅ Yes (independent task, can be done with 1.1)
**Dependencies:** Task 1.1 (types)

**Description:**
- Add `getBinaryNames(): string[]` method to interface
- Add `getAppBundlePaths(platform: Platform): string[]` method to interface
- Add `requiresBinary(): boolean` method to interface
- Update `BaseClientAdapter` with default implementations (empty arrays, false)

**Deliverable:** Extended interface ready for adapter implementations

---

### Phase 2: Adapter Updates (3-4 hours)

**Note:** Tasks 2.1-2.7 can ALL be executed in parallel by different agents

#### Task 2.1: Update claude-code-adapter
**File:** `apps/cli/src/adapters/claude-code-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  return ['claude'];
}

getAppBundlePaths(platform: Platform): string[] {
  return []; // CLI-only client
}

requiresBinary(): boolean {
  return true;
}
```

---

#### Task 2.2: Update claude-desktop-adapter
**File:** `apps/cli/src/adapters/claude-desktop-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  return []; // GUI-only client
}

getAppBundlePaths(platform: Platform): string[] {
  switch (platform) {
    case 'darwin':
      return ['/Applications/Claude.app'];
    case 'win32':
      return [
        'C:\\Program Files\\Claude\\Claude.exe',
        'C:\\Program Files (x86)\\Claude\\Claude.exe'
      ];
    case 'linux':
      return ['/opt/Claude', '/usr/share/applications/claude.desktop'];
  }
}

requiresBinary(): boolean {
  return false; // App bundle sufficient
}
```

---

#### Task 2.3: Update vscode-adapter
**File:** `apps/cli/src/adapters/vscode-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  return ['code'];
}

getAppBundlePaths(platform: Platform): string[] {
  return [];
}

requiresBinary(): boolean {
  return true;
}
```

---

#### Task 2.4: Update cursor-adapter
**File:** `apps/cli/src/adapters/cursor-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  return ['cursor'];
}

getAppBundlePaths(platform: Platform): string[] {
  return [];
}

requiresBinary(): boolean {
  return true;
}
```

---

#### Task 2.5: Update windsurf-adapter
**File:** `apps/cli/src/adapters/windsurf-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  return ['windsurf'];
}

getAppBundlePaths(platform: Platform): string[] {
  switch (platform) {
    case 'darwin':
      return ['/Applications/Windsurf.app'];
    case 'win32':
      return ['C:\\Program Files\\Windsurf\\Windsurf.exe'];
    case 'linux':
      return ['/opt/Windsurf'];
  }
}

requiresBinary(): boolean {
  return false; // Either binary or app bundle
}
```

---

#### Task 2.6: Update copilot-cli-adapter
**File:** `apps/cli/src/adapters/copilot-cli-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  return ['copilot'];
}

getAppBundlePaths(platform: Platform): string[] {
  return [];
}

requiresBinary(): boolean {
  return true;
}
```

---

#### Task 2.7: Update jetbrains-copilot-adapter
**File:** `apps/cli/src/adapters/jetbrains-copilot-adapter.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from other adapters)
**Dependencies:** Task 1.3 (interface)

**Implementation:**
```typescript
getBinaryNames(): string[] {
  // Check for any JetBrains IDE binary
  // TODO: Research - should we check all or let user specify?
  return ['idea', 'pycharm', 'webstorm', 'phpstorm', 'goland', 'rider'];
}

getAppBundlePaths(platform: Platform): string[] {
  return [];
}

requiresBinary(): boolean {
  return true;
}
```

**Note:** JetBrains detection needs further research - this is a placeholder

---

### Phase 3: Sync Engine Integration (2 hours)

#### Task 3.1: Integrate Binary Detection into Sync Engine
**File:** `apps/cli/src/core/sync-engine.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`, `sequentialthinking`
**Parallelizable:** ❌ No (requires Phase 1 & 2 complete)
**Dependencies:** Task 1.2 (BinaryDetector), all Phase 2 tasks (adapters)

**Description:**
- Import `BinaryDetector` service
- In `syncToClient()` function (around line 127), add binary detection before sync
- Check if `options.skipDetection` or `overtureConfig.clients?.skipBinaryDetection` is true
- If detection enabled, call `binaryDetector.detectClient(client, platform)`
- Add warnings if binary not found but proceeding anyway
- Add version info to warnings if detected
- Store detection result in `ClientSyncResult.binaryDetection`

**Deliverable:** Sync engine with integrated binary detection

---

#### Task 3.2: Add skipBinaryDetection Config Option
**File:** `apps/cli/src/domain/config.schema.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7` (Zod schema patterns)
**Parallelizable:** ⚠️ Partial (can do schema, needs 3.1 for usage)
**Dependencies:** Task 1.1 (types)

**Description:**
- Add `clients` optional field to Zod schema
- Add `skipBinaryDetection` boolean field (optional, defaults to false)
- Update validation tests

**Deliverable:** Schema support for skipBinaryDetection option

---

### Phase 4: Doctor Command (2 hours)

#### Task 4.1: Create Doctor Command
**File:** `apps/cli/src/cli/commands/doctor.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`, `sequentialthinking`
**Parallelizable:** ⚠️ Partial (can start structure, needs 1.2 for detection)
**Dependencies:** Task 1.2 (BinaryDetector), Task 3.1 (config loading patterns)

**Description:**
- Create `createDoctorCommand()` function returning Commander Command
- Implement doctor logic:
  1. Load user and project configs (if in project)
  2. Detect all client binaries using BinaryDetector
  3. Validate all config files (check JSON validity)
  4. Check MCP server command availability
  5. Generate colored output with ✓/⚠/✗ symbols
  6. Provide actionable recommendations
- Add options: `--json` for machine-readable output

**Output Format:**
```
Checking client installations...

✓ claude-code (v2.1.0) - /usr/local/bin/claude
  Config: ~/.config/claude/mcp.json (valid)

⚠ vscode - binary not found in PATH
  Recommendation: Install VS Code or add to PATH

✗ copilot-cli - not installed
  Recommendation: Install with 'npm install -g @githubnext/github-copilot-cli'

Checking MCP servers...
✓ github - mcp-server-github (found)
⚠ python-repl - uvx (not found)
  Recommendation: Install uv with 'pip install uv'
```

**Deliverable:** Complete doctor command implementation

---

#### Task 4.2: Register Doctor Command
**File:** `apps/cli/src/cli/index.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`
**Parallelizable:** ❌ No (requires 4.1)
**Dependencies:** Task 4.1 (doctor command)

**Description:**
- Import `createDoctorCommand`
- Add `program.addCommand(createDoctorCommand())` to `createProgram()`

**Deliverable:** Doctor command registered in CLI

---

### Phase 5: CLI Output Enhancement (1 hour)

#### Task 5.1: Update Sync Command Output
**File:** `apps/cli/src/cli/commands/sync.ts`
**Agent:** `javascript-typescript:typescript-pro`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ❌ No (requires 3.1)
**Dependencies:** Task 3.1 (sync engine integration)

**Description:**
- Add detection summary before sync starts
- Show client name, version, and path for found binaries
- Show warnings for not-found binaries
- Use colored output (✓ green, ⚠ yellow, ○ gray for skipped)

**Output:**
```
Detecting installed clients...
✓ claude-code (v2.1.0) - /usr/local/bin/claude
✓ cursor (v0.42.0) - /usr/local/bin/cursor
⚠ vscode - binary not found (generating config anyway)
✓ claude-desktop - /Applications/Claude.app
○ copilot-cli - skipped (detection disabled)

Syncing to 4 clients...
```

**Deliverable:** Enhanced sync output with detection results

---

### Phase 6: Testing (4-5 hours)

**Note:** Tasks 6.1-6.3 can be partially parallelized

#### Task 6.1: Write BinaryDetector Unit Tests
**File:** `apps/cli/src/core/binary-detector.spec.ts`
**Agent:** `unit-testing:test-automator` or `tdd-workflows:tdd-orchestrator`
**MCP Servers:** `filesystem`, `context7` (Jest patterns), `sequentialthinking`
**Parallelizable:** ⚠️ Partial (after 1.2 implementation)
**Dependencies:** Task 1.2 (BinaryDetector implementation)

**Test Coverage:**
- `detectBinary()`:
  - Binary found in PATH
  - Binary not found
  - Version detection success (various formats)
  - Version detection failure
  - Timeout handling
- `detectAppBundle()`:
  - App bundle exists
  - App bundle not found
  - Permission errors
- `validateConfigFile()`:
  - Valid JSON file
  - Invalid JSON
  - File doesn't exist
- `detectClient()`:
  - CLI client with binary found
  - CLI client with binary not found
  - GUI client with app bundle found
  - GUI client with app bundle not found
  - Hybrid client (binary OR app bundle)

**Mock:** `ProcessExecutor.exec()`, `ProcessExecutor.commandExists()`, `fs` module

**Deliverable:** Comprehensive unit tests for BinaryDetector

---

#### Task 6.2: Write Doctor Command Unit Tests
**File:** `apps/cli/src/cli/commands/doctor.spec.ts`
**Agent:** `unit-testing:test-automator` or `tdd-workflows:tdd-orchestrator`
**MCP Servers:** `filesystem`, `context7`, `sequentialthinking`
**Parallelizable:** ⚠️ Partial (after 4.1 implementation)
**Dependencies:** Task 4.1 (doctor command)

**Test Coverage:**
- All clients detected successfully
- Some clients not found
- No clients found
- Invalid config files
- MCP commands not available
- JSON output format
- User vs project context

**Mock:** `BinaryDetector`, `ConfigLoader`, `ProcessExecutor`

**Deliverable:** Unit tests for doctor command

---

#### Task 6.3: Update Adapter Tests
**Files:** All `apps/cli/src/adapters/*-adapter.spec.ts` files
**Agent:** `unit-testing:test-automator`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (each adapter test is independent)
**Dependencies:** Phase 2 tasks (adapter implementations)

**Test Coverage (per adapter):**
- `getBinaryNames()` returns correct binary names
- `getAppBundlePaths(platform)` returns correct paths for each platform
- `requiresBinary()` returns correct value

**Deliverable:** Updated adapter tests covering new methods

---

#### Task 6.4: Write Sync Engine Integration Tests
**File:** `apps/cli/src/core/sync-engine.integration.spec.ts` (or new file)
**Agent:** `unit-testing:test-automator`
**MCP Servers:** `filesystem`, `context7`, `sequentialthinking`
**Parallelizable:** ❌ No (requires Phase 3 complete)
**Dependencies:** Task 3.1 (sync engine integration)

**Test Coverage:**
- Sync with all binaries found
- Sync with some binaries missing (warnings generated)
- Sync with skipBinaryDetection enabled
- Sync with skipBinaryDetection in config
- Version info included in warnings

**Mock:** `BinaryDetector`, adapters, filesystem

**Deliverable:** Integration tests for sync with binary detection

---

### Phase 7: Documentation (1 hour)

**Note:** Tasks 7.1-7.2 can be parallelized with different agents

#### Task 7.1: Update README
**File:** `README.md`
**Agent:** `documentation-generation:docs-architect`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from migration guide)
**Dependencies:** All implementation complete (for accuracy)

**Sections to Update:**
- Add "Binary Detection" section explaining behavior
- Add `overture doctor` command to commands list
- Add `skipBinaryDetection` to configuration examples
- Update "What v0.2.5 includes" section

**Deliverable:** Updated README with v0.2.5 features

---

#### Task 7.2: Create Migration Guide
**File:** `docs/migration-v0.2-to-v0.2.5.md`
**Agent:** `documentation-generation:docs-architect`
**MCP Servers:** `filesystem`, `context7`
**Parallelizable:** ✅ Yes (independent from README)
**Dependencies:** All implementation complete (for accuracy)

**Sections:**
1. Overview of changes
2. Binary detection behavior
3. New `doctor` command
4. Configuration changes (skipBinaryDetection)
5. Breaking changes (none expected)
6. Upgrade instructions

**Deliverable:** Complete migration guide

---

### Phase 8: Final Validation (1 hour)

#### Task 8.1: Run Full Test Suite
**Command:** `nx test @overture/cli`
**Agent:** Manual (or `unit-testing:test-automator` for fixes)
**MCP Servers:** `nx`, `filesystem`
**Parallelizable:** ❌ No (final validation step)
**Dependencies:** All previous tasks complete

**Validation:**
- All tests pass (873+ tests)
- Coverage ≥ 85%
- No TypeScript errors
- No ESLint errors

**Deliverable:** Passing test suite with maintained coverage

---

#### Task 8.2: Manual Testing
**Agent:** Manual
**MCP Servers:** `filesystem`, `nx`
**Parallelizable:** ❌ No (final validation step)
**Dependencies:** Task 8.1 (tests passing)

**Test Scenarios:**
1. Run `overture doctor` with various client installations
2. Run `overture sync` with detection enabled
3. Run `overture sync` with skipBinaryDetection
4. Test on different platforms (macOS, Linux, Windows if available)
5. Verify output formatting and warnings

**Deliverable:** Confirmed working feature

---

## Parallelization Strategy

### Batch 1: Core Foundation (Sequential)
- Task 1.1 → Task 1.3 (can run in parallel)
- Task 1.2 (depends on 1.1 and 1.3)

### Batch 2: All Adapters (Parallel - 7 agents)
- Task 2.1 (claude-code) - Agent A
- Task 2.2 (claude-desktop) - Agent B
- Task 2.3 (vscode) - Agent C
- Task 2.4 (cursor) - Agent D
- Task 2.5 (windsurf) - Agent E
- Task 2.6 (copilot-cli) - Agent F
- Task 2.7 (jetbrains) - Agent G

### Batch 3: Integration (Sequential)
- Task 3.1 (sync engine)
- Task 3.2 (schema) - can overlap with 3.1

### Batch 4: Doctor Command (Sequential)
- Task 4.1 (doctor implementation)
- Task 4.2 (registration)

### Batch 5: Output Enhancement (Sequential)
- Task 5.1 (sync output)

### Batch 6: Testing (Partial Parallel)
- Task 6.1 (binary-detector tests) - After 1.2
- Task 6.2 (doctor tests) - After 4.1
- Task 6.3 (adapter tests) - 7 parallel agents, after Batch 2
- Task 6.4 (integration tests) - After 3.1

### Batch 7: Documentation (Parallel - 2 agents)
- Task 7.1 (README) - Agent A
- Task 7.2 (migration guide) - Agent B

### Batch 8: Validation (Sequential)
- Task 8.1 (test suite)
- Task 8.2 (manual testing)

---

## Agent Assignment Summary

| Agent Type | Tasks | Parallelizable |
|------------|-------|----------------|
| `javascript-typescript:typescript-pro` | 1.1, 1.2, 1.3, 2.1-2.7, 3.1, 3.2, 4.1, 4.2, 5.1 | Batch 2 (7 parallel) |
| `unit-testing:test-automator` | 6.1, 6.2, 6.3, 6.4 | Batch 6.3 (7 parallel) |
| `documentation-generation:docs-architect` | 7.1, 7.2 | Batch 7 (2 parallel) |

**Maximum Parallelization:** 7 agents during Phase 2 (adapter updates)

---

## MCP Server Usage Summary

| MCP Server | Tasks | Usage |
|------------|-------|-------|
| `filesystem` | All file operations | Read/write TypeScript files |
| `context7` | All implementation tasks | TypeScript patterns, Jest patterns, Zod schemas, Node.js APIs |
| `sequentialthinking` | 1.2, 3.1, 4.1, 6.1, 6.4 | Complex logic planning |
| `nx` | 8.1, 8.2 | Build and test execution |
| `memory` | (optional) | Track implementation decisions |

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| JetBrains detection unclear | Mark as TODO, research separately, use basic implementation |
| Version parsing varies by client | Handle multiple formats, graceful fallback |
| Slow binary detection | Add 5s timeout, make skippable |
| Cross-platform differences | Test on multiple platforms, use platform-specific logic |
| Test coverage drops | Write tests alongside implementation (TDD) |

---

## Success Criteria

- ✅ Binary detection works for all 7 clients
- ✅ `overture doctor` command provides useful diagnostics
- ✅ `overture sync` shows detection results
- ✅ Configuration option `skipBinaryDetection` works
- ✅ 873+ tests passing
- ✅ Coverage ≥ 85%
- ✅ Documentation complete and accurate

---

**Total Estimated Time:** 15-18 hours
**Parallelizable Tasks:** 16 out of 27 tasks
**Maximum Parallel Agents:** 7 (during adapter updates)
