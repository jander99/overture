# Overture v0.2 Architecture

**Version:** 2.0
**Date:** 2025-11-11
**Status:** In Development

---

## Table of Contents

1. [Overview](#overview)
2. [Architecture Principles](#architecture-principles)
3. [Directory Structure](#directory-structure)
4. [Layered Architecture](#layered-architecture)
5. [Core Components](#core-components)
6. [Adapter Pattern](#adapter-pattern)
7. [Data Flow](#data-flow)
8. [Configuration Precedence](#configuration-precedence)
9. [Extension Points](#extension-points)

---

## Overview

Overture v0.2 introduces multi-platform MCP server synchronization across multiple AI development clients. The architecture has been redesigned to support:

- **User global configuration** (`~/.config/overture.yml`)
- **Multiple client adapters** (Claude Code, Claude Desktop, VS Code, etc.)
- **Client-aware environment variable expansion**
- **Transport validation** and client-specific schema conversion
- **Backup and restore** functionality
- **Process locking** to prevent concurrent runs

---

## Architecture Principles

### 1. **Separation of Concerns**

The codebase is organized into distinct layers with clear responsibilities:

- **Domain**: Pure types and validation (no dependencies)
- **Infrastructure**: File system and process operations
- **Core**: Business logic and orchestration
- **Adapters**: Client-specific implementations
- **CLI**: User interface and command handling

### 2. **Adapter Pattern**

Each AI client has its own adapter implementing a common `ClientAdapter` interface. This allows:

- **Pluggable clients**: Add new clients without modifying core logic
- **Client-specific logic**: Handle schema differences (VS Code uses `servers` vs `mcpServers`)
- **Environment variable expansion**: Some clients support native expansion, others require Overture to expand

### 3. **Configuration as Code**

User configuration is declarative YAML with version control:

- **Single source of truth**: `~/.config/overture.yml` defines all MCPs and client settings
- **MCP-centric design**: MCPs are defined once, synced to multiple clients with exclusions
- **Precedence model**: Project config overrides user global config

### 4. **Testability**

All components are designed for testability:

- **Dependency injection**: Adapters and services are injected
- **Pure functions**: Path resolution, env var expansion are pure
- **Mocked file system**: Infrastructure layer can be mocked for testing

---

## Directory Structure

```
apps/cli/src/
├── adapters/               # Client-specific adapters (NEW in v0.2)
│   ├── client-adapter.interface.ts
│   ├── adapter-registry.ts
│   ├── claude-code-adapter.ts
│   ├── claude-desktop-adapter.ts
│   ├── vscode-adapter.ts
│   └── jetbrains-copilot-adapter.ts
│
├── cli/                    # Command handlers
│   ├── commands/
│   │   ├── init.command.ts
│   │   ├── sync.command.ts      # Enhanced in v0.2
│   │   ├── validate.command.ts  # Enhanced in v0.2
│   │   ├── user.command.ts      # NEW in v0.2
│   │   ├── audit.command.ts     # NEW in v0.2
│   │   └── backup.command.ts    # NEW in v0.2
│   ├── middleware/
│   └── main.ts
│
├── core/                   # Business logic
│   ├── config-loader.ts         # Enhanced in v0.2
│   ├── path-resolver.ts         # NEW in v0.2
│   ├── env-expander.ts          # NEW in v0.2
│   ├── sync-engine.ts           # NEW in v0.2
│   ├── backup-service.ts        # NEW in v0.2
│   ├── merge-strategy.ts        # NEW in v0.2
│   ├── process-lock.ts          # NEW in v0.2
│   ├── validator.ts             # Enhanced in v0.2
│   ├── generator.ts             # v0.1
│   ├── plugin-installer.ts      # v0.1
│   └── mcp-registry.ts          # v0.1
│
├── domain/                 # Types and schemas
│   ├── types.ts                 # v0.1 types
│   ├── schemas.ts               # v0.1 schemas
│   ├── config-v2.types.ts       # NEW in v0.2
│   ├── config-v2.schema.ts      # NEW in v0.2
│   ├── constants.ts
│   ├── errors.ts
│   └── enums.ts
│
├── infrastructure/         # External interactions
│   ├── fs-utils.ts
│   ├── process-executor.ts
│   ├── template-loader.ts
│   └── path-resolver.ts
│
└── utils/                  # Shared utilities
    ├── logger.ts
    ├── prompts.ts
    ├── format.ts
    └── validation.ts
```

---

## Layered Architecture

### Layer 1: Domain

**Pure domain logic** with **zero external dependencies**.

**Responsibilities:**
- TypeScript interfaces and types
- Zod validation schemas
- Custom error classes
- Enums and constants

**Files:**
- `config-v2.types.ts` - v2.0 configuration types
- `config-v2.schema.ts` - Zod validators

**Key Types:**
```typescript
interface OvertureConfigV2 {
  version: string;
  clients: Record<string, ClientConfig>;
  mcp: Record<string, McpServerConfigV2>;
  sync?: SyncOptions;
}

interface McpServerConfigV2 {
  command: string;
  args: string[];
  env: Record<string, string>;
  transport: 'stdio' | 'http' | 'sse';  // Required
  scope: 'global' | 'project';
  version?: string;  // Optional, defaults to "latest"
  clients?: {
    exclude?: string[];
    include?: string[];
    overrides?: Record<string, Partial<McpServerConfigV2>>;
  };
  platforms?: {
    exclude?: Platform[];
  };
}
```

---

### Layer 2: Infrastructure

**External interactions** (file system, processes).

**Responsibilities:**
- File system operations (read, write, backup)
- Process execution (plugin installation)
- Template loading

**Files:**
- `fs-utils.ts` - File system utilities
- `process-executor.ts` - Process execution
- `template-loader.ts` - Handlebars template loading

---

### Layer 3: Core

**Business logic** and **orchestration**.

**Responsibilities:**
- Configuration loading and merging
- Path resolution with env var expansion
- Sync engine orchestration
- Backup and restore
- Validation and locking

**Key Components:**

#### Config Loader
```typescript
class ConfigLoader {
  loadUserConfig(): OvertureConfigV2
  loadProjectConfig(): OvertureConfigV2 | null
  mergeConfigs(user, project): OvertureConfigV2
}
```

#### Sync Engine
```typescript
class SyncEngine {
  sync(config: OvertureConfigV2, clients: ClientName[]): SyncResult

  private shouldSyncMcp(mcp: McpServerConfigV2, client: ClientName): boolean
  private backupExistingConfig(client: ClientName): void
  private mergeConfigs(existing: ClientMcpConfig, overture: ClientMcpConfig): ClientMcpConfig
}
```

#### Path Resolver
```typescript
function getUserConfigPath(): string
function getClaudeCodeGlobalPath(): string
function getClaudeDesktopPath(platform: Platform): string
function expandEnvVars(path: string): string
```

---

### Layer 4: Adapters

**Client-specific implementations**.

**Responsibilities:**
- Detect client installation
- Read client config
- Write client config
- Convert between formats
- Validate transport support
- Handle environment variable expansion (client-aware)

**Interface:**
```typescript
interface ClientAdapter {
  readonly name: ClientName;
  readonly schemaRootKey: 'mcpServers' | 'servers';

  detectConfigPath(platform: Platform): string | null;
  readConfig(path: string): ClientMcpConfig;
  writeConfig(path: string, config: ClientMcpConfig): void;
  convertFromOverture(overture: OvertureConfigV2): ClientMcpConfig;
  supportsTransport(transport: TransportType): boolean;
  needsEnvVarExpansion(): boolean;
}
```

**Implementations:**
- `ClaudeCodeAdapter` - Claude Code (user + project)
- `ClaudeDesktopAdapter` - Claude Desktop (user only)
- `VSCodeAdapter` - VS Code (uses `servers` key)
- `JetBrainsCopilotAdapter` - JetBrains GitHub Copilot plugin
- `CopilotCliAdapter` - GitHub Copilot CLI (handles bundled GitHub MCP)

---

### Layer 5: CLI

**User interface** and **command handling**.

**Responsibilities:**
- Parse command-line arguments
- Invoke core services
- Display results to user
- Handle errors gracefully

**Commands:**
- `overture init` - Initialize project config
- `overture sync` - Sync to clients
- `overture user init` - Initialize user global config
- `overture audit` - Audit unmanaged MCPs
- `overture backup list` - List backups
- `overture backup restore` - Restore backup

---

## Core Components

### Sync Engine

The sync engine orchestrates multi-client synchronization:

```
┌─────────────────────────────────────────┐
│ 1. Load Configuration                   │
│    - User global (~/.config/overture.yml)│
│    - Project (./.overture/config.yaml)  │
│    - Merge with precedence              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 2. Detect Clients                       │
│    - Check installed clients            │
│    - Filter by enabled clients          │
│    - Get client adapters                │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 3. For Each Client                      │
│    ├─ Apply exclusions                  │
│    ├─ Validate transport support        │
│    ├─ Expand environment variables      │
│    ├─ Convert to client format          │
│    ├─ Backup existing config            │
│    ├─ Merge with existing config        │
│    └─ Write new config                  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 4. Report Results                       │
│    - MCPs synced per client             │
│    - MCPs skipped (exclusions)          │
│    - Errors encountered                 │
│    - Backups created                    │
└─────────────────────────────────────────┘
```

### Exclusion System

Three levels of exclusions:

```
Is MCP globally enabled?
    │
    ├─ No  → SKIP (global exclusion)
    │
    └─ Yes → Is current client in exclude_clients?
              │
              ├─ Yes → SKIP (client exclusion)
              │
              └─ No  → Is current platform in exclude_platforms?
                        │
                        ├─ Yes → SKIP (platform exclusion)
                        │
                        └─ No  → Is include_clients defined?
                                  │
                                  ├─ Yes → Is current client in include_clients?
                                  │         │
                                  │         ├─ Yes → SYNC
                                  │         └─ No  → SKIP
                                  │
                                  └─ No  → SYNC (default: sync to all)
```

### Adapter Registry

The adapter registry provides adapter discovery and instantiation:

```typescript
class AdapterRegistry {
  private adapters: Map<ClientName, ClientAdapter>;

  register(adapter: ClientAdapter): void
  get(name: ClientName): ClientAdapter | undefined
  detectInstalledClients(platform: Platform): ClientName[]
  getAll(): ClientAdapter[]
}
```

---

## Data Flow

### Sync Command Flow

```
User runs: overture sync --clients claude-code,cursor

                │
                ▼
┌───────────────────────────────┐
│ CLI: SyncCommand              │
│ - Parse arguments             │
│ - Load configuration          │
│ - Initialize SyncEngine       │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ ConfigLoader                  │
│ - Load ~/.config/overture.yml │
│ - Load ./.overture/config.yaml│
│ - Merge with precedence       │
│ - Validate with Zod           │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ SyncEngine                    │
│ - Get adapters from registry  │
│ - For each client:            │
│   ├─ shouldSyncMcp()          │
│   ├─ adapter.convertFromOverture()│
│   ├─ backupService.backup()   │
│   ├─ mergeStrategy.merge()    │
│   └─ adapter.writeConfig()    │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ Adapters (multiple in parallel)│
│ - ClaudeCodeAdapter           │
│   ├─ Read existing .mcp.json  │
│   ├─ Merge configs             │
│   └─ Write updated .mcp.json  │
│                               │
│ - CursorAdapter               │
│   ├─ Read existing mcp.json   │
│   ├─ Merge configs             │
│   └─ Write updated mcp.json   │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ CLI: Display Results          │
│ - Summary of changes          │
│ - MCPs synced/skipped         │
│ - Errors encountered          │
│ - Backup locations            │
└───────────────────────────────┘
```

---

## Configuration Precedence

### User vs Project

```yaml
# ~/.config/overture.yml (User Global)
mcp:
  github:
    command: mcp-server-github
    transport: stdio
    scope: global

# ./.overture/config.yaml (Project)
mcp:
  github:
    command: mcp-server-github-custom
    transport: http  # Overrides user global
    scope: project

# Result: Project config takes precedence
# Used command: mcp-server-github-custom
# Used transport: http
```

### Client-Specific Overrides

```yaml
mcp:
  github:
    command: mcp-server-github
    transport: stdio
    scope: global

    clients:
      overrides:
        vscode:
          # VS Code gets HTTP transport
          transport: http

        claude-desktop:
          # Claude Desktop gets custom env var
          env:
            GITHUB_TOKEN: "${CLAUDE_DESKTOP_GITHUB_TOKEN}"
```

---

## Extension Points

### Adding New Clients

1. Create adapter implementing `ClientAdapter` interface
2. Register in `AdapterRegistry`
3. Add client name to `ClientName` enum
4. Add path detection logic
5. Add tests

### Adding New Validation Rules

1. Extend `Validator` class
2. Add validation method
3. Call from `validate.command.ts`
4. Add tests

### Custom Merge Strategies

1. Implement `MergeStrategy` interface
2. Add to `MergeStrategyFactory`
3. Configure in user config (`sync.merge_strategy`)

---

## Version History

- **v0.1** - Initial release with project-level config
- **v0.2** - Multi-platform sync with user global config

---

**Document Version:** 1.0
**Last Updated:** 2025-11-11
